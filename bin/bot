#!/usr/bin/env python3
# This file is placed in the Public Domain.

__version__ = 120

import importlib
import os
import sys 

from hdl import Client, boot, docmd, init, reg
from obj import cfg
from nms import Names, findnames
from prs import parseargs
from trm import exec
from utl import spl

mods = "adm,fnd,irc,log,rss,tdo,udp"

class Console(Client):

    prompt = True

    def handle(self, e):
        super().handle(e)
        e.wait()

    def poll(self):
        if Console.prompt:
            return input("> ")

    def raw(self, txt):
        print(txt)

def scan(mns):
    for mn in spl(mns):
        try:
            mod = importlib.import_module(mn)
        except ImportError:
            continue
        Names.names.update(findnames(mod))
        reg(mn)

def cmd(event):
    event.reply(",".join(sorted(Names.modules)))

def ver(event):
    event.reply("BOT %s" % cfg.version)

def main():
    if "INVOCATION_ID" in os.environ:
        cfg.wd = "/var/lib/bot"
        cfg.mods += "adm,irc"
    else:
        cfg.wd = os.path.expanduser("~/.bot")
        cfg.mods += "adm"
    cfg.name = "bot"
    cfg.version = __version__
    boot()
    c = Console()
    c.add("cmd", cmd)
    c.add("ver", ver)
    if cfg.txt:
        return c.cmd(cfg.otxt)
    c.start()
    scan(cfg.mods)
    init(cfg.mods)
    c.wait()

exec(main)

#!/usr/bin/env python3
# This file is placed in the Public Domain.

import importlib
import os
import sys
import shutil
import unittest

from nms import Names, findnames
from hdl import Client, reg
from obj import cfg, opts
from trm import exec
from utl import spl

import trc
import url

mods = "adm,fnd,irc,log,rss,tdo,udp"

class Test(Client):

    def raw(self, txt):
        if opts("v"):
            print(txt)

class FlushTest(Test):

    def raw(self, txt):
        if opts("v"):
            sys.stdout.write(txt)
            sys.stdout.write("\n")

def scan(mns):
    res = []
    for mn in spl(mns):
        try:
            mod = importlib.import_module(mn)
        except ImportError:
            continue
        Names.names.update(findnames(mod))
        reg(mn)
        res.append(mod)
    return res

def main():
    cfg.opts.v = True
    cfg.wd = ".test"
    shutil.rmtree(".test", True)
    url.debug = True
    c = FlushTest()
    c.start()
    print(scan(mods))
    pat = "test_%s*" % "*"
    suite = unittest.loader.TestLoader().discover("test", pattern=pat)
    unittest.TextTestRunner(verbosity=3).run(suite)

exec(main)
for e in trc.exc:
    print(e)

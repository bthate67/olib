#!/usr/bin/env python3
# This file is placed in the Public Domain.

import importlib
import os
import sys
import shutil
import unittest

sys.path.insert(0, "olib")
sys.path.insert(0, "omod")

from nms import Names, findnames
from hdl import Client, reg
from obj import boot, cfg, opts
from trm import exec
from utl import spl

import obj

import trc
import url

mods = "adm,fnd,irc,log,rss,tdo,udp"

class Test(Client):

    def raw(self, txt):
        if "v" in obj.cfg.opts:
            print(txt)

def scan(mns):
    res = []
    for mn in spl(mns):
        try:
            mod = importlib.import_module(mn)
        except ImportError:
            continue
        Names.names.update(findnames(mod))
        reg(mn)
        res.append(mod)
    return res

def main():
    boot()
    cfg.wd = ".test"
    shutil.rmtree(".test", True)
    url.debug = True
    c = Test()
    c.start()
    scan(mods)
    pat = "test_%s*" % "*"
    suite = unittest.loader.TestLoader().discover("test", pattern=pat)
    unittest.TextTestRunner(verbosity=3).run(suite)

exec(main)
for e in trc.exc:
    print(e)
